using System.Globalization;
using System.Linq;
using System.Text;
using Content.Client.Computer;
using Content.Client.UserInterface.Controls;
using Content.Shared._NF.Atmos.BUIStates;
using Content.Shared.Atmos;
using Content.Shared.Shuttles.Systems;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client._NF.Atmos.UI;

[GenerateTypedNameReferences]
public sealed partial class GaslockConsoleWindow : FancyWindow,
    IComputerWindow<GaslockConsoleBoundUserInterfaceState>
{
    [Dependency] private readonly IEntityManager _entManager = default!;

    private readonly SharedShuttleSystem _shuttles;

    public event Action<NetEntity, NetEntity>? DockRequest;
    public event Action<NetEntity>? UndockRequest;

    public event Action? ToggleStatusButtonPressed;
    public event Action? TogglePumpDirectionButtonPressed;
    public event Action<string>? PumpOutputPressureChanged;

    /// <summary>
    /// Stored by GridID then by docks
    /// </summary>
    public Dictionary<NetEntity, List<GaslockPortState>> Docks = new();

    /// <summary>
    /// Store the dock buttons for the side buttons.
    /// </summary>
    private readonly Dictionary<NetEntity, Button> _ourDockButtons = new();

    public bool PumpStatus;
    public bool PumpInwards;

    public GaslockConsoleWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
        _shuttles = _entManager.System<SharedShuttleSystem>();

        DockingControl.OnViewDock += OnView;
        DockingControl.DockRequest += (entity, netEntity) =>
        {
            DockRequest?.Invoke(entity, netEntity);
        };
        DockingControl.UndockRequest += entity =>
        {
            UndockRequest?.Invoke(entity);
        };

        // Pump controls
        ToggleStatusButton.OnPressed += _ => SetPumpStatus(!PumpStatus);
        ToggleStatusButton.OnPressed += _ => ToggleStatusButtonPressed?.Invoke();

        ToggleDirectionButton.OnPressed += _ => SetPumpDirection(!PumpInwards);
        ToggleDirectionButton.OnPressed += _ => TogglePumpDirectionButtonPressed?.Invoke();

        PumpPressureOutputInput.OnTextChanged += _ => SetOutputPressureButton.Disabled = false;
        SetOutputPressureButton.OnPressed += _ =>
        {
            PumpOutputPressureChanged?.Invoke(PumpPressureOutputInput.Text ??= "");
            SetOutputPressureButton.Disabled = true;
        };

        SetMaxPressureButton.OnPressed += _ =>
        {
            PumpPressureOutputInput.Text = Atmospherics.MaxOutputPressure.ToString(CultureInfo.CurrentCulture);
            SetOutputPressureButton.Disabled = false;
        };
    }

    public void UpdateState(EntityUid? shuttle, GaslockConsoleBoundUserInterfaceState state)
    {
        var entCoords = _entManager.GetCoordinates(state.Coords);
        Docks = state.State.Docks;
        DockingControl.DockState = state;
        DockingControl.GridEntity = shuttle;
        BuildDocks(entCoords.EntityId);
    }

    private void OnView(NetEntity obj)
    {
        if (_ourDockButtons.TryGetValue(obj, out var viewed))
        {
            viewed.Pressed = true;
        }
    }

    private void BuildDocks(EntityUid? shuttle)
    {
        DockingControl.BuildDocks(shuttle);
        var currentDock = DockingControl.ViewedDock;
        DockPorts.DisposeAllChildren();
        _ourDockButtons.Clear();

        if (shuttle == null)
        {
            DockingControl.SetViewedDock(null);
            return;
        }

        var shuttleNent = _entManager.GetNetEntity(shuttle.Value);

        if (!Docks.TryGetValue(shuttleNent, out var shuttleDocks) || shuttleDocks.Count <= 0)
            return;

        var dockText = new StringBuilder();
        var buttonGroup = new ButtonGroup();
        var idx = 0;
        var selected = false;
        GaslockPortState? firstState = null;

        // Build the dock buttons for our docks.
        foreach (var dock in shuttleDocks.OrderBy(x => x.LabelName ?? x.Name))
        {
            if (idx == 0)
                firstState = dock;

            idx++;
            dockText.Clear();
            dockText.Append(dock.LabelName ?? dock.Name);

            var button = new Button()
            {
                Text = dockText.ToString(),
                ToggleMode = true,
                Group = buttonGroup,
                Margin = new Thickness(0f, 3f),
            };

            button.OnMouseEntered += args =>
            {
                DockingControl.HighlightedDock = dock.Entity;
            };

            button.OnMouseExited += args =>
            {
                DockingControl.HighlightedDock = null;
            };

            button.Label.Margin = new Thickness(3f);

            if (currentDock == dock.Entity)
            {
                selected = true;
                button.Pressed = true;
            }

            button.OnPressed += args =>
            {
                OnDockPress(dock);
            };

            _ourDockButtons[dock.Entity] = button;
            DockPorts.AddChild(button);
        }

        // Button group needs one selected so just show the first one.
        if (!selected)
            OnDockPress(firstState!);

        var shuttleContainers = new Dictionary<NetEntity, GaslockObject>();

        foreach (var dock in shuttleDocks.OrderBy(x => x.GridDockedWith))
        {
            if (dock.GridDockedWith == null)
                continue;

            GaslockObject? dockContainer;

            if (!shuttleContainers.TryGetValue(dock.GridDockedWith.Value, out dockContainer))
            {
                dockContainer = new GaslockObject();
                shuttleContainers[dock.GridDockedWith.Value] = dockContainer;
                var dockGrid = _entManager.GetEntity(dock.GridDockedWith);
                string? iffLabel = null;

                if (_entManager.EntityExists(dockGrid))
                {
                    iffLabel = _shuttles.GetIFFLabel(dockGrid.Value);
                }

                iffLabel ??= Loc.GetString("shuttle-console-unknown");
                dockContainer.SetName(iffLabel);
                // DockedWith.AddChild(dockContainer);
            }

            dockContainer.AddDock(dock, DockingControl);

            dockContainer.ViewPressed += () =>
            {
                OnDockPress(dock);
            };

            dockContainer.UndockPressed += () =>
            {
                UndockRequest?.Invoke(dock.Entity);
            };
        }
    }

    private void OnDockPress(GaslockPortState state)
    {
        DockingControl.SetViewedDock(state);
    }

    public void SetOutputPressure(float pressure)
    {
        PumpPressureOutputInput.Text = pressure.ToString(CultureInfo.CurrentCulture);
    }

    public void SetPumpStatus(bool enabled)
    {
        PumpStatus = enabled;
        if (enabled)
        {
            ToggleStatusButton.Text = Loc.GetString("comp-gas-pump-ui-status-enabled");
        }
        else
        {
            ToggleStatusButton.Text = Loc.GetString("comp-gas-pump-ui-status-disabled");
        }
    }

    public void SetPumpDirection(bool inwards)
    {
        PumpInwards = inwards;
        if (inwards)
        {
            ToggleDirectionButton.Text = Loc.GetString("comp-gas-pump-ui-direction-in");
        }
        else
        {
            ToggleDirectionButton.Text = Loc.GetString("comp-gas-pump-ui-direction-out");
        }
    }
}
