using Content.Client.GameTicking.Managers;
using Content.Client.Lobby;
using Content.Client.Players.PlayTimeTracking;
using Content.Shared.Preferences;
using Content.Shared.Roles;
using Content.Shared.StatusIcon;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Client.Utility;
using Robust.Shared.Prototypes;

namespace Content.Client._NF.Latejoin;

[GenerateTypedNameReferences]
public sealed partial class NewFrontierLateJoinJobButton : Button
{
    private readonly IPrototypeManager _prototypeManager;
    private readonly ClientGameTicker _gameTicker;
    private readonly NetEntity _station;
    private readonly JobRequirementsManager _jobReqs;
    private readonly IClientPreferencesManager _preferencesManager;
    private readonly string _jobId;

    public NewFrontierLateJoinJobButton(NetEntity station, string jobId, ClientGameTicker gameTicker, IPrototypeManager prototypeManager, JobRequirementsManager jobReqs, IClientPreferencesManager preferencesManager)
    {
        RobustXamlLoader.Load(this);
        _prototypeManager = prototypeManager;
        _gameTicker = gameTicker;
        _station = station;
        _jobId = jobId;
        _jobReqs = jobReqs;
        _preferencesManager = preferencesManager;

        _gameTicker.LobbyJobsAvailableUpdated += UpdateButton;
        UpdateButton(_gameTicker.JobsAvailable);
    }

    protected override void Dispose(bool disposing)
    {
        base.Dispose(disposing);
        _gameTicker.LobbyJobsAvailableUpdated -= UpdateButton;
    }

    private void UpdateButton(IReadOnlyDictionary<NetEntity, Dictionary<ProtoId<JobPrototype>, int?>> obj)
    {
        if (!obj.ContainsKey(_station) || !obj[_station].ContainsKey(_jobId))
        {
            Visible = false;
            return;
        }

        if (_preferencesManager.Preferences?.SelectedCharacter is not HumanoidCharacterProfile profile)
        {
            Visible = false;
            return;
        }

        var prototype = _prototypeManager.Index<JobPrototype>(_jobId);

        if (_prototypeManager.TryIndex<JobIconPrototype>(prototype.Icon, out var jobIcon))
        {
            JobIcon.Texture = jobIcon.Icon.Frame0();
        }

        JobText.Text = $"{prototype.LocalizedName} ({obj[_station][_jobId]?.ToString() ?? "Unlimited"})";

        Disabled = obj[_station][_jobId] == 0 || !_jobReqs.IsAllowed(prototype, profile, out var _);
    }
}
