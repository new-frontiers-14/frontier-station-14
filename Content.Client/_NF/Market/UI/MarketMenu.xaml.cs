using Content.Client.UserInterface.Controls;
using Content.Shared._NF.Market;
using Content.Shared._NF.Market.BUI;
using Content.Shared.Cargo.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;

namespace Content.Client._NF.Market.UI;

[GenerateTypedNameReferences]
public sealed partial class MarketMenu : FancyWindow
{
    [Dependency] private readonly IPrototypeManager _protoManager = default!;
    [Dependency] private readonly ILocalizationManager _loc = default!;

    public event Action<BaseButton.ButtonEventArgs>? OnAddToCart;
    public event Action<BaseButton.ButtonEventArgs>? OnReturn;
    public event Action<BaseButton.ButtonEventArgs>? OnPurchaseCart;

    private MarketConsoleInterfaceState? _lastStateUpdate;
    private string _searchText = "";

    public MarketMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        PurchaseCart.OnPressed += args => OnPurchaseCart?.Invoke(args);
        SearchText.OnTextChanged += args => OnSearchTextChanged(args.Text);
        ClearSearchButton.OnPressed += ClearSearchText;
    }

    private void ClearSearchText(BaseButton.ButtonEventArgs args)
    {
        _searchText = "";
        SearchText.Text = "";
        if (_lastStateUpdate != null)
        {
            UpdateState(_lastStateUpdate);
        }
    }

    public void SetUiEnabled(bool enabled)
    {
        SearchText.Editable = enabled;
        PurchaseCart.Disabled = !enabled;
    }

    private void OnSearchTextChanged(string text)
    {
        _searchText = text;
        if (_lastStateUpdate != null)
        {
            UpdateState(_lastStateUpdate);
        }
    }

    public void UpdateState(MarketConsoleInterfaceState uiState)
    {
        _lastStateUpdate = uiState;
        Populate(uiState.MarketDataList, uiState.CartDataList, uiState.MarketModifier, uiState.Enabled);
        BalanceLabel.Text = $" ${uiState.Balance}";
        CartBalanceLabel.Text = $" ${uiState.CartBalance}";
        SetUiEnabled(uiState.Enabled);
    }

    private void Populate(List<MarketData> data, List<MarketData> cartData, float marketModifier, bool enabled = true)
    {
        Products.RemoveAllChildren();
        Cart.RemoveAllChildren();

        AddRows(Products, false, data, marketModifier, enabled);
        AddRows(Cart, true, cartData, marketModifier, enabled);
    }

    private void AddRows(Control container, bool isCart, List<MarketData> data, float marketModifier, bool enabled = true)
    {
        foreach (var marketData in data)
        {
            // Try to get the EntityPrototype that matches marketData.Prototype
            if (!_protoManager.TryIndex<EntityPrototype>(marketData.Prototype, out var prototype))
            {
                continue; // Skip this iteration if the prototype was not found
            }

            if (!IsWithinSearchQuery(prototype))
                continue;

            if (!prototype.TryGetComponent<SpriteComponent>(out var sprite))
            {
                continue; // Skip this iteration if the prototype was not found
            }

            var price = 0f;
            if (prototype.TryGetComponent<StaticPriceComponent>(out var staticPrice))
            {
                price = (float) (staticPrice.Price * marketModifier);
            }

            var roundedPrice = (int) Math.Round(price);

            if (isCart)
            {
                var productRow = new MarketCartProductRow(marketData.Prototype)
                {
                    Title = { Text = prototype.Name },
                    Quantity = { Text = marketData.Quantity.ToString() },
                    Price = { Text = $"${roundedPrice}" },
                    Icon = { Texture = sprite.Icon?.Default }
                };
                productRow.Return.OnPressed += args => { OnReturn?.Invoke(args); };
                productRow.Return.Disabled = !enabled;

                container.AddChild(productRow);
            }
            else
            {
                var productRow = new MarketProductRow(marketData.Prototype)
                {
                    Title = { Text = prototype.Name },
                    Quantity = { Text = _loc.GetString("market-quantity-available").Replace("$1", marketData.Quantity.ToString()) },
                    Price = { Text = $"${roundedPrice}" },
                    Icon = { Texture = sprite.Icon?.Default }
                };
                productRow.AddToCart.OnPressed += args => { OnAddToCart?.Invoke(args); };
                productRow.AddToCart.Disabled = !enabled;

                container.AddChild(productRow);
            }
        }
    }

    private bool IsWithinSearchQuery(EntityPrototype prototype)
    {
        var text = _searchText.Trim();
        return string.IsNullOrEmpty(text) || prototype.Name.Contains(text);
    }
}
