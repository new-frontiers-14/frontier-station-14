using Content.Shared._NF.DeviceLinking;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.CustomControls;
using Robust.Shared.Localization;
using Robust.Client.GameObjects;
using Robust.Shared.GameObjects;
using Robust.Shared.IoC;
using Robust.Shared.Maths;
using Robust.Shared.Input;
using static Robust.Client.UserInterface.Controls.BoxContainer;
using Range = Robust.Client.UserInterface.Controls.Range;

namespace Content.Client._NF.DeviceLinking.UI;

[GenerateTypedNameReferences]
public sealed partial class RngDeviceWindow : DefaultWindow
{
    private RngDeviceBoundUserInterfaceState? _state;
    private bool _updatingControls;

    public event Action<bool>? OnMuteToggled;
    public event Action<bool>? OnEdgeModeToggled;
    public event Action<int>? OnTargetNumberChanged;

    public RngDeviceWindow()
    {
        RobustXamlLoader.Load(this);
        Title = Loc.GetString("rng-device-window-title");

        MuteCheckBox.OnToggled += OnMuteCheckBoxToggled;
        EdgeModeCheckBox.OnToggled += OnEdgeModeCheckBoxToggled;
        TargetNumberSpinBox.ValueChanged += OnTargetNumberSpinBoxChanged;
        TargetNumberSlider.OnValueChanged += OnTargetNumberSliderChanged;
        TargetNumberSlider.OnKeyBindUp += OnTargetNumberSliderReleased;
        MinusButton.OnPressed += _ => AdjustTargetNumber(-1);
        PlusButton.OnPressed += _ => AdjustTargetNumber(1);
    }

    private void AdjustTargetNumber(int delta)
    {
        var newValue = Math.Clamp(TargetNumberSpinBox.Value + delta, 1, 100);
        TargetNumberSpinBox.Value = newValue;
    }

    private void OnMuteCheckBoxToggled(BaseButton.ButtonToggledEventArgs args)
    {
        OnMuteToggled?.Invoke(args.Pressed);
    }

    private void OnEdgeModeCheckBoxToggled(BaseButton.ButtonToggledEventArgs args)
    {
        OnEdgeModeToggled?.Invoke(args.Pressed);
    }

    private void OnTargetNumberSpinBoxChanged(ValueChangedEventArgs args)
    {
        if (_updatingControls)
            return;

        var value = (int)args.Value;
        _updatingControls = true;
        OnTargetNumberChanged?.Invoke(value);
        TargetNumberSlider.SetValueWithoutEvent(value);
        _updatingControls = false;
    }

    private void OnTargetNumberSliderChanged(Range slider)
    {
        if (_updatingControls)
            return;

        var value = (int)slider.Value;
        _updatingControls = true;
        TargetNumberSpinBox.OverrideValue(value);
        _updatingControls = false;
    }

    private void OnTargetNumberSliderReleased(GUIBoundKeyEventArgs args)
    {
        if (args.Function != EngineKeyFunctions.UIClick)
            return;

        OnTargetNumberChanged?.Invoke((int)TargetNumberSlider.Value);
    }

    public void UpdateState(RngDeviceBoundUserInterfaceState state)
    {
        _state = state;
        _updatingControls = true;
        MuteCheckBox.Pressed = state.Muted;
        EdgeModeCheckBox.Pressed = state.EdgeMode;

        Title = Loc.GetString("rng-device-window-title", ("type", state.DeviceType));

        // Only update values if the slider isn't being dragged
        if (!TargetNumberSlider.Grabbed)
        {
            TargetNumberSpinBox.OverrideValue(state.TargetNumber);
            TargetNumberSlider.SetValueWithoutEvent(state.TargetNumber);
        }

        TargetNumberContainer.Visible = state.Outputs == 2; // Only show for percentile variant
        _updatingControls = false;
    }
}
