using System.Linq;
using Content.Client.Stylesheets;
using Content.Client.UserInterface.Controls;
using Content.Shared._NF.ShuttleRecords;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;

namespace Content.Client._NF.ShuttleRecords.UI;

[GenerateTypedNameReferences]
public sealed partial class ShuttleRecordsWindow : FancyWindow
{
    [Dependency] private readonly ILocalizationManager _loc = default!;
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly IGameTiming _gameTiming = default!;

    public Action<ShuttleRecord>? OnCopyDeed;
    public ShuttleRecord? SelectedShuttleRecord;
    private ShuttleRecordsConsoleInterfaceState? _lastStateUpdate;
    private List<ShuttleRecord> _lastRecordSet = [];
    private string _searchText = "";

    private TimeSpan? ButtonResetOn { get; set; }

    public ShuttleRecordsWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        SearchText.OnTextChanged += args => OnSearchTextChanged(args.Text);
        ShowActiveOnlyCheckbox.OnPressed += _ => UpdateStateIfExists();
        ClearSearchButton.OnPressed += ClearSearchText;
    }

    private void OnSearchTextChanged(string text)
    {
        _searchText = text;
        UpdateStateIfExists();
    }

    private void ClearSearchText(BaseButton.ButtonEventArgs args)
    {
        _searchText = "";
        SearchText.Text = "";
        UpdateStateIfExists();
    }

    private void UpdateStateIfExists()
    {
        if (_lastStateUpdate != null)
        {
            UpdateState(_lastStateUpdate, false);
        }
    }

    public void UpdateState(ShuttleRecordsConsoleInterfaceState state, bool rememberState = true)
    {
        if (rememberState)
        {
            _lastStateUpdate = state;
            if (state.Records != null)
                _lastRecordSet = state.Records;
        }

        TargetIdButton.Text = state.IsTargetIdPresent
            ? Loc.GetString("id-card-console-window-eject-button")
            : Loc.GetString("id-card-console-window-insert-button");

        TargetIdLabel.Text = state.TargetIdFullName;
        ShipNameLabel.Text = state.TargetIdVesselName;

        var lastRecords = state.Records ?? _lastRecordSet;
        if (lastRecords != null)
        {
            ShuttleRecordList.RemoveAllChildren();
            var viewStateList = BuildShuttleRecordListItemViewStateList(lastRecords, ShowActiveOnlyCheckbox.Pressed);
            foreach (var pair in viewStateList)
            {
                var listItem = new ShuttleRecordListItem(pair.ViewState);
                listItem.OnPressed += _ => OnShuttleRecordListItemPressed(pair.ShuttleRecord);
                ShuttleRecordList.AddChild(listItem);
            }
        }

        if (SelectedShuttleRecord != null)
            UpdateSelectedShuttleRecord(SelectedShuttleRecord);
    }

    public record ShuttleRecordViewStatePair(
        ShuttleRecord ShuttleRecord,
        ShuttleRecordListItem.ViewState ViewState
    );

    private List<ShuttleRecordViewStatePair> BuildShuttleRecordListItemViewStateList(
        List<ShuttleRecord> shuttleRecords,
        bool onlyShowActive)
    {
        return shuttleRecords
            .Where(shuttleRecord => string.IsNullOrEmpty(_searchText) ||
                                    shuttleRecord.Name.Contains(_searchText, StringComparison.CurrentCultureIgnoreCase) ||
                                    (shuttleRecord.Suffix != null && shuttleRecord.Suffix.Contains(_searchText, StringComparison.CurrentCultureIgnoreCase)) ||
                                     shuttleRecord.OwnerName.Contains(_searchText, StringComparison.CurrentCultureIgnoreCase))
            .Where(shuttleRecord => !onlyShowActive || ShuttleExists(netEntity: shuttleRecord.EntityUid))
            .Select(shuttleRecord =>
                new ShuttleRecordViewStatePair(
                    shuttleRecord,
                    new ShuttleRecordListItem.ViewState(
                        shuttleRecord.Name + " " + shuttleRecord.Suffix,
                        disabled: SelectedShuttleRecord != null && shuttleRecord.EntityUid == SelectedShuttleRecord.EntityUid,
                        toolTip: ""
                    )
                ))
            .ToList();
    }

    private void OnShuttleRecordListItemPressed(ShuttleRecord shuttleRecord)
    {
        UpdateSelectedShuttleRecord(shuttleRecord);
        // Need to update the UI for the selected ship
        if (_lastStateUpdate != null)
            UpdateState(_lastStateUpdate, false);
    }

    private void UpdateSelectedShuttleRecord(ShuttleRecord shuttleRecord)
    {
        SelectedShuttleRecord = shuttleRecord;
        ShuttleRecordDetailsContainer.RemoveAllChildren();
        var shuttleExists = ShuttleExists(netEntity: shuttleRecord.EntityUid);
        var shuttleStatus = shuttleExists
            ? _loc.GetString(messageId: "shuttle-records-shuttle-status-active")
            : _loc.GetString(messageId: "shuttle-records-shuttle-status-inactive");
        var timeOfPurchaseText = "N/A";
        if (shuttleRecord.TimeOfPurchase != null)
        {
            timeOfPurchaseText = Loc.GetString("shuttle-records-time-of-purchase",
                ("time", shuttleRecord.TimeOfPurchase.Value.ToString("hh\\:mm\\:ss")));
        }

        var transactionPrice = SharedShuttleRecordsSystem.GetTransactionCost(
            percent: _lastStateUpdate?.TransactionPercentage ?? 0,
            min: _lastStateUpdate?.MinTransactionPrice ?? 0,
            max: _lastStateUpdate?.MaxTransactionPrice ?? uint.MaxValue,
            vesselPrice: shuttleRecord.PurchasePrice,
            fixedPrice: _lastStateUpdate?.FixedTransactionPrice
        );
        var viewState = new ShuttleRecordDetailsControl.ViewState(
            shuttleName: _loc.GetString(messageId: "shuttle-records-shuttle-name-label",
                arg: ("name", shuttleRecord.Name + " " + shuttleRecord.Suffix)),
            shuttleOwnerName: _loc.GetString(messageId: "shuttle-records-shuttle-owner-label",
                arg: ("owner", shuttleRecord.OwnerName)),
            shuttlePrice: _loc.GetString(messageId: "shuttle-records-shuttle-price-label",
                arg: ("price", shuttleRecord.PurchasePrice)),
            activity: _loc.GetString(messageId: "shuttle-records-shuttle-status", arg: ("status", shuttleStatus)),
            toolTip: "",
            timeOfPurchase: timeOfPurchaseText,
            voucherStatus: shuttleRecord.PurchasedWithVoucher ? _loc.GetString(messageId: "shuttle-records-purchased-voucher") : "",
            transactionCost: _loc.GetString(messageId: "shuttle-records-transaction-cost",
                arg: ("cost", transactionPrice))
            );
        var control = new ShuttleRecordDetailsControl(state: viewState);
        control.CopyDeedButton.Disabled = !shuttleExists;
        control.CopyDeedButton.OnPressed += _ =>
        {
            if (ButtonResetOn is null)
            {
                ButtonResetOn = _gameTiming.CurTime.Add(TimeSpan.FromSeconds(3));
                control.CopyDeedButton.AddStyleClass(StyleBase.ButtonCaution);
                control.CopyDeedButtonLabel.Text = Loc.GetString("shuttle-records-transaction-confirm");
                return;
            }

            ResetConfirmButton();
            OnCopyDeed?.Invoke(shuttleRecord);
        };
        ShuttleRecordDetailsContainer.AddChild(child: control);
    }

    private bool ShuttleExists(NetEntity netEntity)
    {
        return _entityManager.TryGetEntity(netEntity, out _);
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        // Resets the "Are you sure?" state.
        // This checks for null for free, do not invert it as null always produces a false value
        if (SelectedShuttleRecord != null && _gameTiming.CurTime > ButtonResetOn)
        {
            ResetConfirmButton();
        }
    }

    private void ResetConfirmButton()
    {
        if (SelectedShuttleRecord != null)
        {
            ButtonResetOn = null;
            UpdateSelectedShuttleRecord(SelectedShuttleRecord);
        }
    }
}
