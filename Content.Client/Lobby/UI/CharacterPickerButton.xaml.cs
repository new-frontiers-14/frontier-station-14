using System.Numerics;
using Content.Client.Lobby.UI.ProfileEditorControls;
using Content.Client.Stylesheets;
using Content.Shared.Preferences;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Player;
using Robust.Shared.Prototypes;

namespace Content.Client.Lobby.UI;

/// <summary>
/// Holds character data on the side of the setup GUI.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class CharacterPickerButton : ContainerButton
{
    public event Action? OnDeletePressed;

    public HumanoidCharacterProfile Profile { get; private init; }

    public CharacterPickerButton(
        IClientPreferencesManager prefMan,
        IPrototypeManager protoMan,
        ISharedPlayerManager playerMan,
        ButtonGroup group,
        HumanoidCharacterProfile profile,
        bool isSelected,
        bool simple = false)
    {
        RobustXamlLoader.Load(this);
        AddStyleClass(StyleClassButton);
        ToggleMode = true;
        Group = group;

        Profile = profile;

        View.Initialize(prefMan, protoMan, playerMan);
        View.LoadPreview(profile);

        Pressed = isSelected;

        DescriptionLabel.Text = View.FullDescription;

        foreach (var panel in new List<PanelContainer> { DeleteButtonOutline })
        {
            if (panel.PanelOverride is not StyleBoxTexture styleBox)
                continue;
            styleBox.Texture = Theme.ResolveTexture("/Textures/Interface/Nano/slider_outline.svg.96dpi.png");
            styleBox.SetPatchMargin(StyleBox.Margin.All, 12);
            styleBox.SetContentMarginOverride(StyleBox.Margin.All, 0);
            styleBox.SetExpandMargin(StyleBox.Margin.All, 1);
            styleBox.TextureScale = new Vector2(1.1f);
            styleBox.Modulate = StyleNano.PanelDark;
        }

        if (simple)
        {
            ButtonDivider.Visible = false;
            ButtonBox.Visible = false;
        }
        else
        {
            AddStyleClass("OpenRight");
            DeleteButtonOutline.Visible = !isSelected;

            DeleteButton.OnPressed += _ => { OnDeletePressed?.Invoke(); };
        }
    }
}
